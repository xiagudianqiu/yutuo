<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>屿拓网站图片优化工具</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: #f0f0f0;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #FFDF00;
        }
        .card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .dropzone {
            border: 2px dashed #FFDF00;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .dropzone:hover {
            background: rgba(255, 223, 0, 0.1);
        }
        .button {
            background: #FFDF00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 223, 0, 0.3);
        }
        .button:disabled {
            background: #777;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        .preview-item {
            width: calc(50% - 10px);
            background: #333;
            border-radius: 8px;
            padding: 10px;
            box-sizing: border-box;
        }
        .preview-item img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .size-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        progress {
            width: 100%;
            height: 15px;
            margin: 10px 0;
        }
        .settings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .setting-item {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #333;
            color: #fff;
        }
        .download-all {
            margin-top: 20px;
            text-align: center;
        }
        .results {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        .savings {
            color: #4CAF50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>屿拓网站图片优化工具</h1>
    <p>使用此工具可以快速压缩网站图片，提高加载速度。推荐使用WebP格式以获得最佳效果。</p>
    
    <div class="card">
        <h2>1. 设置优化参数</h2>
        <div class="settings">
            <div class="setting-item">
                <label for="format">输出格式</label>
                <select id="format">
                    <option value="webp">WebP (推荐，最佳压缩比)</option>
                    <option value="jpeg">JPEG (照片类型)</option>
                    <option value="png">PNG (需要透明度)</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="quality">质量 (1-100)</label>
                <input type="range" id="quality" min="1" max="100" value="80">
                <output for="quality">80</output>
            </div>
            <div class="setting-item">
                <label for="maxWidth">最大宽度 (像素)</label>
                <input type="number" id="maxWidth" value="1600" min="100">
            </div>
            <div class="setting-item">
                <label for="maxSize">目标文件大小 (KB)</label>
                <input type="number" id="maxSize" value="200" min="10">
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>2. 添加图片</h2>
        <div id="dropzone" class="dropzone">
            <p>拖放图片到这里，或点击选择文件</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
        </div>
    </div>
    
    <div class="card">
        <h2>3. 优化结果</h2>
        <div id="progressContainer" style="display: none;">
            <p>正在处理图片...</p>
            <progress id="progress" value="0" max="100"></progress>
        </div>
        <div id="imagePreview" class="image-preview"></div>
        <div class="download-all">
            <button id="downloadAllBtn" class="button" disabled>下载所有优化图片</button>
        </div>
        <div class="results">
            <div id="resultsSummary"></div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const progressContainer = document.getElementById('progressContainer');
            const progress = document.getElementById('progress');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const qualityInput = document.getElementById('quality');
            const qualityOutput = qualityInput.nextElementSibling;
            const resultsSummary = document.getElementById('resultsSummary');
            
            let optimizedImages = [];
            
            // 设置质量滑块输出
            qualityInput.addEventListener('input', function() {
                qualityOutput.textContent = this.value;
            });
            
            // 点击上传区域
            dropzone.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件选择监听
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFiles(this.files);
                }
            });
            
            // 拖放功能
            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropzone.style.borderColor = '#4CAF50';
                dropzone.style.background = 'rgba(255, 223, 0, 0.2)';
            });
            
            dropzone.addEventListener('dragleave', function() {
                dropzone.style.borderColor = '#FFDF00';
                dropzone.style.background = 'transparent';
            });
            
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.style.borderColor = '#FFDF00';
                dropzone.style.background = 'transparent';
                
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            // 下载所有按钮
            downloadAllBtn.addEventListener('click', function() {
                if (optimizedImages.length > 0) {
                    const zip = new JSZip();
                    
                    optimizedImages.forEach(img => {
                        const format = document.getElementById('format').value;
                        const filename = img.originalName.split('.')[0] + '.' + format;
                        zip.file(filename, img.blob);
                    });
                    
                    zip.generateAsync({type: 'blob'}).then(function(content) {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(content);
                        link.download = '屿拓网站优化图片.zip';
                        link.click();
                    });
                }
            });
            
            // 处理文件
            function handleFiles(files) {
                if (files.length === 0) return;
                
                // 重置
                imagePreview.innerHTML = '';
                optimizedImages = [];
                resultsSummary.innerHTML = '';
                downloadAllBtn.disabled = true;
                
                // 显示进度
                progressContainer.style.display = 'block';
                progress.max = files.length;
                progress.value = 0;
                
                let processed = 0;
                let totalOriginalSize = 0;
                let totalOptimizedSize = 0;
                
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        
                        img.onload = function() {
                            processImage(img, file, function(optimizedBlob, previewUrl) {
                                // 创建预览容器
                                const previewItem = document.createElement('div');
                                previewItem.className = 'preview-item';
                                
                                // 预览图片
                                const previewImg = document.createElement('img');
                                previewImg.src = previewUrl;
                                previewItem.appendChild(previewImg);
                                
                                // 大小信息
                                const sizeInfo = document.createElement('div');
                                sizeInfo.className = 'size-info';
                                
                                const originalSize = (file.size / 1024).toFixed(2);
                                const newSize = (optimizedBlob.size / 1024).toFixed(2);
                                const savingsPercent = (100 - (optimizedBlob.size / file.size * 100)).toFixed(1);
                                
                                totalOriginalSize += file.size;
                                totalOptimizedSize += optimizedBlob.size;
                                
                                sizeInfo.innerHTML = `
                                    <span>原始: ${originalSize} KB</span>
                                    <span>优化后: ${newSize} KB</span>
                                    <span class="savings">节省: ${savingsPercent}%</span>
                                `;
                                previewItem.appendChild(sizeInfo);
                                
                                // 下载按钮
                                const downloadBtn = document.createElement('button');
                                downloadBtn.className = 'button';
                                downloadBtn.style.width = '100%';
                                downloadBtn.style.marginTop = '10px';
                                downloadBtn.textContent = '下载';
                                
                                downloadBtn.addEventListener('click', function() {
                                    const format = document.getElementById('format').value;
                                    const link = document.createElement('a');
                                    link.href = URL.createObjectURL(optimizedBlob);
                                    link.download = file.name.split('.')[0] + '.' + format;
                                    link.click();
                                });
                                
                                previewItem.appendChild(downloadBtn);
                                imagePreview.appendChild(previewItem);
                                
                                // 保存到优化图像数组
                                optimizedImages.push({
                                    blob: optimizedBlob,
                                    originalName: file.name
                                });
                                
                                processed++;
                                progress.value = processed;
                                
                                // 全部处理完成后
                                if (processed === files.length) {
                                    progressContainer.style.display = 'none';
                                    downloadAllBtn.disabled = false;
                                    
                                    // 显示总结
                                    const totalOriginalMB = (totalOriginalSize / (1024 * 1024)).toFixed(2);
                                    const totalOptimizedMB = (totalOptimizedSize / (1024 * 1024)).toFixed(2);
                                    const totalSavingsPercent = (100 - (totalOptimizedSize / totalOriginalSize * 100)).toFixed(1);
                                    
                                    resultsSummary.innerHTML = `
                                        <div class="card" style="margin-top: 20px;">
                                            <h3>优化总结</h3>
                                            <p>处理图片: ${files.length} 张</p>
                                            <p>原始总大小: ${totalOriginalMB} MB</p>
                                            <p>优化后总大小: ${totalOptimizedMB} MB</p>
                                            <p>总节省空间: <span class="savings">${totalSavingsPercent}%</span></p>
                                        </div>
                                    `;
                                }
                            });
                        };
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            // 处理图片
            function processImage(img, file, callback) {
                const format = document.getElementById('format').value;
                const quality = parseInt(document.getElementById('quality').value) / 100;
                const maxWidth = parseInt(document.getElementById('maxWidth').value);
                const targetSize = parseInt(document.getElementById('maxSize').value) * 1024; // 转为字节
                
                // 计算新尺寸，保持宽高比
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    const ratio = maxWidth / width;
                    width = maxWidth;
                    height = Math.round(height * ratio);
                }
                
                // 创建canvas
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // 转换为blob
                let currentQuality = quality;
                let mimeType;
                
                switch(format) {
                    case 'webp':
                        mimeType = 'image/webp';
                        break;
                    case 'jpeg':
                        mimeType = 'image/jpeg';
                        break;
                    case 'png':
                        mimeType = 'image/png';
                        break;
                    default:
                        mimeType = 'image/webp';
                }
                
                canvas.toBlob(function(blob) {
                    // 如果blob太大，尝试进一步压缩
                    if (blob.size > targetSize && currentQuality > 0.2) {
                        // 二分法寻找最佳质量
                        compressWithBinarySearch(canvas, mimeType, currentQuality, targetSize, function(finalBlob) {
                            callback(finalBlob, URL.createObjectURL(finalBlob));
                        });
                    } else {
                        callback(blob, URL.createObjectURL(blob));
                    }
                }, mimeType, currentQuality);
            }
            
            // 二分法寻找最佳质量
            function compressWithBinarySearch(canvas, mimeType, startQuality, targetSize, callback) {
                let min = 0.1;
                let max = startQuality;
                let mid = (min + max) / 2;
                let iteration = 0;
                const maxIterations = 5; // 限制迭代次数以避免过度压缩
                
                function iterate() {
                    iteration++;
                    canvas.toBlob(function(blob) {
                        if (blob.size <= targetSize || iteration >= maxIterations || Math.abs(max - min) < 0.05) {
                            callback(blob);
                        } else if (blob.size > targetSize) {
                            max = mid;
                            mid = (min + max) / 2;
                            iterate();
                        } else {
                            min = mid;
                            mid = (min + max) / 2;
                            iterate();
                        }
                    }, mimeType, mid);
                }
                
                iterate();
            }
        });
    </script>
    
    <!-- 引入JSZip用于批量下载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html> 